---
title: 光线跟踪算法基础
categories: [Computer Science and Technology, Computer Graphics]
tags: [ray-tracing, rendering, global-illumination, Whitted-algorithm, path-tracing]
math: true
description: "本文详细介绍光线跟踪算法的基本原理、历史发展与实现方法，包括光线与场景求交、光线投射、Whitted-Style光线跟踪和蒙特卡洛路径追踪等技术，以及与传统光栅化渲染的区别与应用场景。"
---

## 1. 光线跟踪概述

### 1.1 基本原理

光线跟踪是一种有效且被广泛使用的真实感绘制算法，它通过模拟光线的传播路径来创建高度逼真的图像。与传统的光栅化渲染不同，光线跟踪能够实现全局光照效果，模拟光线在场景中的多次弹射，从而产生更加真实的视觉体验。

>在物理世界中，我们之所以能看见物体，是因为光线从光源发出，经物体表面反复弹射后，部分光线最终进入视点、射入人们的眼中。光线跟踪算法正是基于这一物理过程进行模拟，追踪光线在虚拟场景中的传播路径。
{:.prompt-info}

光线跟踪算法以逆向方式工作——从观察者（相机）出发，通过屏幕像素向场景投射光线，计算光线与场景物体的交点，然后根据物体材质属性和光照条件确定该像素的颜色。这种逆向跟踪方法比从光源向各个方向发射光线更为高效，因为大多数从光源发出的光线永远不会到达观察者的视点。

### 1.2 主要特征与优势

光线跟踪的突出特征包括：

- **真实的光照效果**：能够准确模拟阴影、反射和折射等复杂的光学现象，创造出高度逼真的图像
- **广泛的适用性**：适用于各种几何表示，包括基本几何形体（球体、立方体等）和复杂的物体表示方法（多边形网格、复合形体等）
- **物理准确性**：基于物理光学原理，能够模拟真实世界中的光线传播行为
- **参考标准**：作为一种经典的绘制方法，常用作ground truth（基准真值），用于验证和比较新的绘制方法的正确性

早期的光线跟踪算法主要面向室内规则场景，如著名的康奈尔盒（Cornell Box）。随着技术的发展，现代光线跟踪已经能够处理极其复杂的场景和材质，广泛应用于电影特效、建筑可视化和产品设计等领域。

### 1.3 光线跟踪 vs 光栅化渲染

在计算机图形学中，光线跟踪和光栅化是两种主要的渲染方法，各有其优势和适用场景：

**光栅化渲染**：
- **优势**：速度快，有成熟的硬件加速渲染流水线，适合实时渲染（>30FPS），是游戏和交互式应用的主流技术
- **局限**：质量相对较低，难以准确模拟光线的多次弹射，全局光照效果通常需要通过各种近似技术实现

**光线跟踪渲染**：
- **优势**：质量更高，能够自然地模拟各种光学现象，渲染结果更接近真实物理世界
- **局限**：传统上计算成本高，在专用硬件（如NVIDIA RTX系列GPU）出现前主要用于离线渲染，如电影特效和动画制作

>近年来，随着NVIDIA RTX等专用硬件的发展，实时光线跟踪技术已经开始应用于游戏和交互式应用中。《控制》、《赛博朋克2077》、《死亡搁浅：导演剪辑版》等游戏都采用了实时光线跟踪技术，为玩家带来更加逼真的视觉体验。这标志着计算机图形学正在进入一个新的时代，光栅化和光线跟踪的界限正在逐渐模糊。
{:.prompt-info}

## 2. 光线跟踪的历史发展

### 2.1 光线跟踪的起源与里程碑

光线跟踪技术的发展历程充满了创新与突破：

- **1968年**：Arthur Appel首次提出光线投射（Ray Casting）的概念，用于计算可见性和阴影
- **1980年**：Turner Whitted发表了具有里程碑意义的论文《An improved illumination model for shaded display》，首次提出了包含光反射和折射效果的模型，被称为Whitted模型，并给出了递归式光线跟踪算法（Whitted-Style Ray Tracing）的范例
- **1984年**：美国康奈尔大学的Donald Greenberg教授和日本广岛大学的西田友是（Nishita）教授分别将热辐射工程中的辐射度方法引入到计算机图形学中
- **1986年**：James Kajiya提出了著名的渲染方程，为全局光照渲染奠定了理论基础
- **1990年代**：光子映射（Photon Mapping）等高级全局光照算法被开发出来，进一步提高了光线跟踪的真实感
- **2000年代**：基于物理的渲染（Physically Based Rendering）和蒙特卡洛路径追踪（Monte Carlo Path Tracing）技术日趋成熟
- **2018年**：NVIDIA发布RTX系列GPU，首次在消费级硬件上实现了实时光线跟踪，开启了实时光线跟踪的新时代

### 2.2 光线跟踪的先驱：Turner Whitted

Turner Whitted是光线跟踪算法的奠基人，其贡献对计算机图形学产生了深远影响：

- 于1978年在北卡罗来纳州立大学（NCSU）获得博士学位，之后加入贝尔实验室
- 1979年在SIGGRAPH会议上首次提出了递归式光线跟踪算法，次年在ACM通讯（Communications of the ACM）上发表
- 学术生涯中共发表36篇论文，其中11篇发表在SIGGRAPH，2篇发表在Communication of the ACM
- 2003年当选美国工程院院士
- 其提出的Whitted模型至今仍是图形学教学和研究中的重要内容

>Turner Whitted的论文《An improved illumination model for shaded display》被认为是计算机图形学历史上的里程碑之作，它第一次展示了如何使用递归式光线跟踪算法创建具有高度真实感的图像，包括精确的阴影、反射和折射效果。这项工作奠定了现代光线跟踪技术的基础，影响了几代图形学研究者和工程师。
{:.prompt-info}

## 3. 光线求交技术

在光线跟踪中，计算光线与场景物体的交点是最基本也是计算量最大的步骤。高效的光线求交算法对于光线跟踪的性能至关重要。

### 3.1 光线的数学表示

光线（射线）可以用参数方程表示为：

$$P(t) = R_o + t \cdot R_d$$

其中：
- $R_o = (x_o, y_o, z_o)$ 是光线的起点（原点）
- $R_d = (x_d, y_d, z_d)$ 是光线的方向向量，通常是单位向量
- 参数 $t$ 表示光线在方向 $R_d$ 上行进的距离，当 $t > 0$ 时表示光线的前进方向

通过这种参数表示，光线上的任何点都可以通过参数 $t$ 来唯一确定。求解光线与物体的交点，实际上就是求解参数 $t$ 的过程。

### 3.2 光线与基本几何体求交

#### 3.2.1 光线与平面求交

平面可以用点法式表示为：

$$n \cdot P + D = 0$$

其中 $n$ 是平面的法向量，$D$ 是常数。

将光线方程代入平面方程：

$$n \cdot (R_o + t \cdot R_d) + D = 0$$

解得：

$$t = \frac{-(D + n \cdot R_o)}{n \cdot R_d}$$

需要验证 $t > 0$ 以确保交点在光线的前进方向上。当 $n \cdot R_d = 0$ 时，光线与平面平行，不存在交点。

#### 3.2.2 光线与三角形求交

三角形是计算机图形学中最常用的基本几何单元。计算光线与三角形的交点通常分为两步：
1. 首先计算光线与三角形所在平面的交点
2. 然后判断该交点是否位于三角形内部

判断点是否在三角形内部，可以使用重心坐标法：
对于三角形 $P_0P_1P_2$ 内的点 $P$，其重心坐标 $(\alpha, \beta, \gamma)$ 满足：

$$P = \alpha P_0 + \beta P_1 + \gamma P_2$$
$$\alpha + \beta + \gamma = 1$$

当 $\alpha, \beta, \gamma$ 都在 $[0,1]$ 范围内时，点 $P$ 位于三角形内部。

这可以通过解线性方程组实现：

$$\begin{pmatrix} P - P_0 \end{pmatrix} = \beta \begin{pmatrix} P_1 - P_0 \end{pmatrix} + \gamma \begin{pmatrix} P_2 - P_0 \end{pmatrix}$$

使用克莱默法则（Cramer's Rule）求解，我们可以得到：

$$t = \frac{\det(S, E_1, E_2)}{\det(R_d, E_1, E_2)}$$
$$\beta = \frac{\det(S, R_d, E_2)}{\det(R_d, E_1, E_2)}$$
$$\gamma = \frac{\det(S, E_1, R_d)}{\det(R_d, E_1, E_2)}$$

其中：
- $E_1 = P_1 - P_0$
- $E_2 = P_2 - P_0$
- $S = R_o - P_0$

交点合法的条件是：$t > 0$，$\beta \geq 0$，$\gamma \geq 0$，$\beta + \gamma \leq 1$。

#### 3.2.3 光线与球体求交

对于中心为 $P_c$ 半径为 $r$ 的球体，其方程为：

$$|P - P_c|^2 = r^2$$

将光线方程代入球体方程：

$$|R_o + t \cdot R_d - P_c|^2 = r^2$$

展开后得到一个关于 $t$ 的二次方程：

$$t^2 + 2t \cdot \frac{R_d \cdot (R_o - P_c)}{|R_d|^2} + \frac{|R_o - P_c|^2 - r^2}{|R_d|^2} = 0$$

当 $R_d$ 是单位向量时，上式简化为：

$$t^2 + 2t \cdot (R_d \cdot (R_o - P_c)) + |R_o - P_c|^2 - r^2 = 0$$

定义：
- $a = 1$ (当 $R_d$ 是单位向量时)
- $b = 2(R_d \cdot (R_o - P_c))$
- $c = |R_o - P_c|^2 - r^2$

则光线与球体的交点对应的参数 $t$ 是：

$$t = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}$$

光线与球体可能有0个、1个或2个交点：
- 如果判别式 $b^2 - 4ac < 0$，则没有交点
- 如果判别式 $b^2 - 4ac = 0$，则有1个交点（光线与球体相切）
- 如果判别式 $b^2 - 4ac > 0$，则有2个交点，取其中较小的正值作为最近交点

**几何方法**：

除了代数方法，还可以使用几何方法计算光线与球体的交点：
1. 计算光源指向球心的向量 $l = P_c - R_o$
2. 计算 $l$ 在光线方向上的投影长度 $t_p = l \cdot R_d$
3. 计算球心到光线的距离 $d^2 = |l|^2 - t_p^2$
4. 如果 $d > r$，则光线与球体不相交
5. 计算从投影点到交点的距离 $t' = \sqrt{r^2 - d^2}$
6. 最终，交点对应的参数 $t = t_p - t'$ (如果光源在球体外部) 或 $t = t_p + t'$ (如果光源在球体内部)

这种几何方法在很多情况下比代数方法更高效，尤其是可以在很早阶段判断光线与球体是否相交。

#### 3.2.4 光线与长方体求交

光线与轴对齐长方体（Axis-Aligned Bounding Box, AABB）的求交在计算机图形学中非常重要，因为长方体常用作复杂几何体的包围盒（Bounding Box），用于加速光线跟踪。

一种高效的算法是"slab"方法：
1. 将长方体视为三对平行平面（slabs）的交集
2. 对每对平行平面，计算光线与它们的交点参数 $t_{min}$ 和 $t_{max}$
3. 计算所有对的 $t_{min}$ 中的最大值 $t_{enter}$ 和所有 $t_{max}$ 中的最小值 $t_{exit}$
4. 如果 $t_{enter} < t_{exit}$ 且 $t_{exit} > 0$，则光线与长方体相交

对于沿坐标轴放置的长方体，Woo算法提供了进一步的优化：
1. 首先确定三个较近的平面（过滤掉远的平面）
2. 计算光线与这三个平面的交点
3. 将交点参数中最大的作为候选交点
4. 检查候选交点是否真的位于长方体的表面上

### 3.3 光线与多边形求交

对于一般多边形，求交过程通常分为两步：
1. 计算光线与多边形所在平面的交点
2. 判断该交点是否位于多边形内部

判断点是否在多边形内部可以使用以下方法：

**弧长法**：
1. 以被测点为圆心，作单位圆
2. 计算多边形各边在单位圆上产生的弧长代数和
3. 如果代数和为0，点在多边形外部；如果代数和为2π，点在多边形内部；如果代数和为π，点在多边形边上

**交点检测算法（奇偶检测）**：
基于Jordan曲线定理，从点发出一条射线，计算与多边形边界的交点数量：
- 如果交点数为奇数，点在多边形内部
- 如果交点数为偶数，点在多边形外部

交点检测算法是所有无需预处理的方法中最快的，实现方法为：
1. 将需检测的点作为坐标原点
2. 使用X轴正半轴作为检测射线
3. 对多边形的每条边进行判断：
   - 如果边的两个端点的Y坐标符号相同，则该边与射线无交点
   - 否则，计算该边与X轴的交点
   - 如果交点在X轴正半轴上，交点计数加1

## 4. 光线跟踪算法类型

光线跟踪技术随着计算机图形学的发展不断演进，形成了多种不同的算法变体，各自适用于不同的应用场景。

### 4.1 光线投射（Ray Casting）

光线投射是最基本的光线跟踪形式，只考虑从视点到场景中第一个交点的直接光照：

1. **基本流程**：
   - 将视窗区域看作由空间中像素组成的矩形阵列
   - 对每个像素，从视点向像素中心发射一条光线
   - 计算该光线与场景中各物体的交点，找出距离视点最近的交点
   - 根据交点处的材质、法向量以及光照条件，使用局部光照模型计算像素颜色

2. **光线投射算法伪代码**：

```
对于每个像素：
    - 发射光线，寻找与场景中最近的交点
    - 如果存在交点：
        - 计算环境光照贡献
        - 对于场景中的每个光源：
            - 判断交点是否在该光源的阴影中
                - 如果不在阴影中，计算该光源对该点的照明贡献
        - 返回最终颜色
    - 否则：
        - 返回背景色
```

3. **阴影计算**：
   - 从交点向光源方向发射"阴影射线"（Shadow Ray）
   - 如果阴影射线与任何物体相交，则交点位于阴影中
   - 此时只计算环境光贡献，不计算该光源的直接照明

光线投射只考虑光线的第一次弹射，不能模拟反射、折射等效果，因此渲染效果相对有限。但它计算效率高，是更复杂光线跟踪算法的基础。

### 4.2 Whitted-Style光线跟踪

Whitted-Style光线跟踪是Turner Whitted在1980年提出的递归式光线跟踪算法，它扩展了光线投射，加入了镜面反射和透明折射的处理：

1. **基本原理**：
   - 从视点出发，经过像素中心向场景发射主光线（Primary Ray）
   - 计算主光线与场景的第一个交点，使用局部光照模型计算直接光照
   - 根据材质特性，沿交点处的反射和折射方向继续递归跟踪
   - 反射和折射光线的贡献按材质的反射率和透明度权重加到最终颜色中

2. **递归式光线跟踪算法伪代码**：

```
函数 IntersectColor(起点, 方向)：
    - 计算光线与场景的交点
    - 初始化颜色为环境光贡献
    - 对于每个光源：
        - 如果交点不在该光源的阴影中：
            - 累加该光源的局部光照贡献
    - 如果表面具有反射特性：
        - 计算反射方向
        - 颜色 += 反射系数 * IntersectColor(交点, 反射方向)
    - 如果表面具有折射特性：
        - 计算折射方向
        - 颜色 += 折射系数 * IntersectColor(交点, 折射方向)
    - 返回颜色
```

3. **反射光线计算**：
   - 根据反射定律：入射角等于反射角
   - 反射光线方向：$R = I - 2(I \cdot N)N$，其中$I$是入射光线方向，$N$是表面法向量

4. **折射光线计算**：
   - 根据斯涅尔定律（Snell's Law）：$\eta_i \sin \theta_i = \eta_t \sin \theta_t$
   - 折射光线方向：$T = \eta_i I - (\eta_i (I \cdot N) + \sqrt{1 - \eta_i^2(1 - (I \cdot N)^2)})N$，其中$\eta_i$和$\eta_t$是入射和折射介质的折射率比值

5. **递归终止条件**：
   - 达到预设的最大递归深度
   - 光线贡献低于设定阈值
   - 光线离开场景边界

Whitted-Style光线跟踪虽然能够生成包含反射和折射效果的图像，但仍有局限性：它只能处理完美镜面反射和透明折射，不能模拟漫反射面之间的光能传递（间接光照）或模糊反射等更复杂的光学现象。

### 4.3 蒙特卡洛光线跟踪（路径追踪）

蒙特卡洛光线跟踪（Monte Carlo Ray Tracing）、也称为路径追踪（Path Tracing），是一种更先进的光线跟踪技术，能够模拟更复杂的光照现象：

1. **基本原理**：
   - 使用蒙特卡洛积分方法估计渲染方程
   - 随机采样半球空间，模拟各种光照路径
   - 通过大量采样逼近真实的光照分布

2. **主要特点**：
   - 支持混合材质特性（如部分镜面反射、部分漫反射）
   - 能够模拟间接光照，包括漫反射表面之间的光能传递
   - 采用随机采样策略，如轮盘赌（Russian Roulette）技术决定光线的散射行为

3. **算法流程**：
   - 从视点发射主光线
   - 计算主光线与场景的交点
   - 根据材质特性（反射率、透明度等）随机决定光线的下一步行为
   - 如果决定为漫反射，则在半球随机选择一个方向继续跟踪
   - 重复上述过程，直到光线到达光源或被终止
   - 多次渲染并累积结果，减少噪声

4. **优缺点**：
   - 优点：能产生物理上更准确的图像，支持复杂材质和全局光照
   - 缺点：收敛速度慢，需要大量采样才能得到无噪声的图像，计算成本高

蒙特卡洛光线跟踪的核心是用随机采样来估计渲染方程中的半球积分：

$$L_o(x, \omega_o) = L_e(x, \omega_o) + \int_{\Omega} f_r(x, \omega_i, \omega_o) L_i(x, \omega_i) (\omega_i \cdot n) d\omega_i$$

通过大量的路径采样，路径追踪可以自然地模拟色彩渗透（Color Bleeding）等间接光照效果，但对于焦散（Caustics）等特殊光照效果的处理能力相对有限。

### 4.4 高级光线跟踪技术

为了解决基本路径追踪的局限性，研究人员开发了多种高级光线跟踪技术：

1. **双向路径追踪（Bidirectional Path Tracing, BDPT）**：
   - 同时从相机和光源出发构建路径，然后连接这些路径
   - 更有效地处理复杂光照情况，特别是涉及间接照明的场景

2. **光子映射（Photon Mapping）**：
   - 分两阶段工作：光子传播阶段和渲染阶段
   - 首先从光源发射光子并记录它们在场景中的交点
   - 然后在渲染阶段使用这些存储的光子估计辐射亮度
   - 特别适合渲染焦散和其他复杂光照效果

3. **元路径追踪（Metropolis Light Transport, MLT）**：
   - 基于马尔可夫链蒙特卡洛（MCMC）方法
   - 通过扰动已知的高贡献光路来发现更多类似的重要光路
   - 在难以采样的光照条件下特别有效

4. **多重重要性采样（Multiple Importance Sampling, MIS）**：
   - 结合多种采样策略，减少方差
   - 提高采样效率，特别是在处理复杂材质时

5. **体积光线跟踪（Volumetric Ray Tracing）**：
   - 处理参与介质（如烟、雾、云）中的光线散射
   - 模拟体积光效果，如体积散射、体积焦散等

这些高级技术各有优缺点，在不同的应用场景中发挥作用。在现代渲染系统中，通常会根据具体需求组合使用多种技术。

## 5. 光线跟踪的实现与优化

光线跟踪的计算成本很高，特别是在复杂场景中。为了提高渲染效率，需要采用各种优化技术。

### 5.1 加速结构

加速结构是提高光线跟踪性能的关键：

1. **包围体积层次结构（Bounding Volume Hierarchy, BVH）**：
   - 将场景中的物体组织成树状结构
   - 每个节点包含一个包围盒，包含其所有子节点的物体
   - 光线与包围盒测试可以快速排除大量不相交的物体

2. **kd树（k-dimensional Tree）**：
   - 将空间递归地划分为两个部分
   - 对于静态场景非常高效
   - 构建复杂但查询快速

3. **均匀网格（Uniform Grid）**：
   - 将空间划分为大小相等的单元格
   - 简单且适用于分布均匀的场景
   - 对于不均匀分布的场景效率较低

### 5.2 光线求交优化

除了加速结构，还可以通过优化光线求交计算来提高性能：

1. **光线包（Ray Packets）**：
   - 同时处理多条相似方向的光线
   - 利用SIMD指令并行计算
   - 提高内存一致性和计算效率

2. **早期射线终止（Early Ray Termination）**：
   - 一旦确定当前交点不是最近交点，立即停止计算
   - 避免不必要的精确交点计算

3. **自适应采样（Adaptive Sampling）**：
   - 在场景的复杂区域使用更多采样
   - 在简单区域使用较少采样
   - 提高整体渲染效率

### 5.3 并行与硬件加速

现代光线跟踪系统大量依赖硬件加速：

1. **GPU加速**：
   - 利用图形处理器的并行计算能力
   - NVIDIA RTX系列GPU拥有专用的光线跟踪硬件单元（RT Core）

2. **分布式渲染**：
   - 将渲染任务分配到多台机器上
   - 特别适用于大规模生产环境，如电影特效渲染

3. **混合渲染管线**：
   - 结合光栅化和光线跟踪的优势
   - 例如，使用光栅化渲染基本场景，使用光线跟踪处理反射、阴影等效果

### 5.4 防止自遮挡问题

在实践中，光线跟踪需要处理各种数值问题：

1. **自遮挡（Self-Intersection）**：
   - 由于浮点数精度限制，计算出的交点可能轻微偏离表面
   - 当从交点发射反射或阴影光线时，可能误判为与自身相交
   - 解决方法：沿表面法线方向略微偏移起点或使用容差值

2. **退化情况处理**：
   - 光线与平面相切
   - 光线恰好通过多边形顶点
   - 这些情况需要特殊处理以避免数值不稳定

## 6. 光线跟踪的应用与未来

光线跟踪技术正在不断发展，其应用范围也在不断扩大。

### 6.1 现实应用

光线跟踪目前在多个领域有广泛应用：

1. **电影与动画**：
   - 高质量的离线渲染
   - 特效和真实感图像生成
   - 几乎所有现代CG电影都使用基于光线跟踪的渲染技术

2. **建筑与产品可视化**：
   - 照明设计和分析
   - 真实感产品展示
   - 建筑方案的预览和评估

3. **游戏行业**：
   - 实时光线跟踪逐渐成为高端游戏的标准
   - 混合渲染技术：结合光栅化和光线跟踪
   - 光线追踪的全局照明、反射和阴影

4. **虚拟现实（VR）和增强现实（AR）**：
   - 提高沉浸感的真实感渲染
   - 实时交互式体验

### 6.2 未来发展趋势

光线跟踪技术正在朝着以下方向发展：

1. **实时光线跟踪**：
   - 硬件加速技术的不断进步
   - 混合渲染管线的优化
   - 去噪算法的改进

2. **人工智能辅助渲染**：
   - 机器学习去噪
   - 智能采样策略
   - 神经网络辅助光线跟踪

3. **物理精确的模拟**：
   - 更准确的光谱渲染
   - 更复杂的材质和散射模型
   - 波动光学效应的模拟

4. **大规模场景渲染**：
   - 城市级别场景的高效渲染
   - 流式加载和过程式生成技术

>随着NVIDIA、AMD和Intel等公司投入大量资源开发专用光线追踪硬件，以及软件技术的不断创新，实时光线追踪正在成为主流渲染技术。我们可以预见，在不久的将来，光线追踪将在游戏、交互式媒体和实时可视化领域扮演越来越重要的角色。
{:.prompt-info}

## 7. 总结

光线跟踪是计算机图形学中极其重要的渲染技术，它通过模拟光线的物理传播过程，能够创建高度真实的图像。从最初的Whitted光线跟踪到现代的路径追踪和高级全局光照算法，光线跟踪技术已经发展成为一个丰富而复杂的领域。

作为一种基于物理的渲染方法，光线跟踪在真实感图像生成方面具有无可比拟的优势。尽管传统上计算成本较高，但随着硬件技术的飞速发展和算法的不断优化，实时光线跟踪已经成为现实，并正在改变计算机图形学的格局。

光线跟踪算法的美妙之处在于其简单而强大的核心思想：追踪光线在虚拟世界中的旅程。这一思想不仅在视觉渲染中有广泛应用，也启发了声音传播、无线信号模拟等其他领域的发展。随着技术的不断进步，光线跟踪必将在更广阔的领域发挥作用，创造更丰富、更逼真的虚拟世界体验。